# 实体解析

实体解析是工具的最重要的功能之一，它可以解析用户的实体，提取出实体的属性和关系。本篇文档将详细说明实体解析相关的内容，你将了解

- 使用Roslyn解析实体类
- 使用`EntityFrameworkCore.Design`解析DbContext和实体
- 解析结果结构:`EntityInfo`

## 使用Roslyn解析实体类

实体解析使用了Roslyn来解析C#代码中的实体类。通过分析代码中的类定义、属性和方法，工具可以提取出实体的结构信息。

主要的解析逻辑在`EntityParseHelper`中实现.

## 使用`EntityFrameworkCore.Design`解析DbContext和实体

这种方案在实现上稍微有些复杂，但理论上能够获取关于数据库上下文和实体的各种信息，以增加后续代码生成的智能化。

具体步骤：

1. 使用Roslyn加载目标项目的程序集，如`EntityFramework`。
2. 先找到abstract的继承`DbContext`的基类，如`ContextBase`。
3. 从程序集中获取所有继承自基类如`ContextBase`的非abstract的数据库上下文。
4. 创建上下文实例，获取`DbContext`的`Model`属性获取实体模型，返回一个字典。
5. 使用时，根据实体获取到对应的上下文，然后查询字典，获取Model属性，从而获取实体的相关信息。

涉及到的实现类

- `DbContextAnalysisHelper.cs`，使用Roslyn解析目标程序集，获取DbContext信息
- `DbContextAnalyzer.cs`，创建`DbContext`实例，提供`FrozenDictionary<string, IModel>`类型的字典
- `DbContextParseHelper`，根据字典来获取对应实体的信息，提供`EntityInfo`。

这里的核心是如何创建目标程序集的`DbContext`实例，我们既没有通过启用Host，从而获取依赖注入的服务，也没有使用`IDesignTimeDbContextFactory`(目标程序可能不提供，提供会影响ef工具行为)，而是直接使用`Activator.CreateInstance`来创建实例。

这里的核心在于如何构建`DbContext`所需要的参数`DbContextOptionsBuilder`。可以直接使用工具中的Sqlite相关程序集，来构建该参数，
我们的目的是获取实体模型信息，并不需要使用跟目标程序一致的数据库提供程序。你会看到以下代码:

```csharp
 // use tool's sqlite assembly
 var sqliteAssembly = Assembly.Load("Microsoft.EntityFrameworkCore.Sqlite");
 var sqliteExtensionsType = sqliteAssembly.GetType(
     "Microsoft.EntityFrameworkCore.SqliteDbContextOptionsBuilderExtensions"
 );

 if (sqliteExtensionsType != null)
 {
     var useSqliteMethod = sqliteExtensionsType.GetMethod(
         "UseSqlite",
         [optionsBuilderType, typeof(string), typeof(Action<object>)]
     );

     useSqliteMethod?.Invoke(null, [optionsBuilder, "DataSource=temp", null]);
 }

 var options = optionsBuilder.Options;
 dbContextInstance = Activator.CreateInstance(contextType, options) as DbContext;
```

## 解析说明

使用`Roslyn`进行语义和语法解析，是对源代码内容进行解析，能够获取到用户代码的原始表达。

使用`EntityFrameworkCore.Design`解析`DbContext`和实体，本质上是对编译后的程序集进行反射，获取到编译后的实体信息，但一些原始的代码信息可能无法获取，如：

```csharp
public UserType UserType { get; set; } = UserType.Normal;
```

其中的`= UserType.Normal;`无法通过反射获取到。

编译会去除一些内容，如注释，条件编译等信息。

通过结合`Roslyn`和`EntityFrameworkCore.Design`，我们可以获取到更全面的实体信息。